<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Residencia en Espa√±a - Expatriarse.com</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': '#10b981', 
                        'secondary': '#f97316', 
                        'accent': '#1e40af', 
                        'background': '#f4f4f5', 
                        'card': '#ffffff', 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f4f5; font-family: 'Inter', sans-serif; padding: 1rem; }
        .chat-container { max-width: 800px; height: 650px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .chat-window { height: calc(100% - 120px); overflow-y: auto; scroll-behavior: smooth; }
        .message-bubble { border-radius: 1.25rem; }
        .ai-message { background-color: #d1fae5; }
        .user-message { background-color: #3b82f6; }
        #email-capture-screen { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.98); z-index: 10; }
        
        .header-content { display: flex; flex-direction: row; align-items: center; justify-content: space-between; }
        .logo-title-group { display: flex; align-items: center; }
        .text-group { display: flex; flex-direction: column; justify-content: center; }
        
        .domain-title { font-size: 0.75rem; color: #6b7280; font-weight: 600; margin-bottom: 0px; text-transform: lowercase; letter-spacing: 0.05em; }
        .main-title { font-size: 1.1rem; font-weight: 800; color: #1e40af; line-height: 1.1; }
        .limit-badge { font-size: 0.75rem; font-weight: 600; color: #059669; background-color: #ecfdf5; padding: 0.25rem 0.75rem; rounded-full; border: 1px solid #10b981; }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen">

<div class="chat-container w-full bg-card rounded-3xl flex flex-col p-6">
    
    <!-- PANTALLA DE BIENVENIDA (LOGIN) -->
    <div id="email-capture-screen" class="flex justify-center items-center p-8 text-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border border-gray-100">
            <!-- Logo Grande - Usando la imagen subida -->
            <img src="uploaded:espatriarse logo.png-191d1e30-2d94-4871-b4ee-4de637ed174e" alt="Logo Expatriarse" class="h-20 mx-auto mb-6 object-contain">
            
            <h2 class="text-2xl font-bold text-gray-800 mb-3 text-center">Bienvenido a tu Asistente de Residencia en Espa√±a üá™üá∏</h2>
            <p class="text-gray-600 mb-6 leading-relaxed text-sm text-center">
                Estamos aqu√≠ para ayudarte a resolver tus dudas migratorias. Para mantener esta herramienta gratuita y accesible para toda la comunidad, te pedimos un breve registro.<br><br>
                Al ingresar, tendr√°s acceso a <strong>5 consultas de orientaci√≥n gratuitas por d√≠a</strong>.
            </p>
            
            <input type="email" id="capture-email-input" placeholder="Tu correo electr√≥nico aqu√≠" 
                   class="w-full p-4 border border-gray-300 rounded-xl focus:ring-accent focus:border-accent transition duration-150 shadow-inner mb-4 text-gray-700 text-center text-lg">
            
            <button id="start-session-button" 
                    class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:opacity-50 transform hover:scale-[1.02]">
                Ingresar al Asistente
            </button>
            <p id="email-error-message" class="text-xs text-red-500 mt-3 hidden text-center">Por favor, escribe un email v√°lido para continuar.</p>
        </div>
    </div>

    <!-- ENCABEZADO CHAT -->
    <header class="pb-4 border-b border-gray-200 relative">
        <div class="header-content">
            <div class="logo-title-group">
                <!-- Logo Peque√±o - Usando la imagen subida -->
                <img src="uploaded:espatriarse logo.png-191d1e30-2d94-4871-b4ee-4de637ed174e" alt="Logo Peque√±o" class="h-10 mr-3 object-contain">
                <div class="text-group">
                    <span class="domain-title">expatriarse.com</span>
                    <h1 class="main-title">Asistente de Residencia</h1>
                </div>
            </div>
            <!-- Badge de L√≠mite -->
            <div id="limit-badge-container">
                <p id="query-limit-status" class="limit-badge">
                    5 consultas disponibles
                </p>
            </div>
        </div>
    </header>

    <!-- CHAT -->
    <div id="chat-window" class="chat-window flex flex-col space-y-4 p-4 mb-4 flex-grow"></div>

    <!-- INPUT -->
    <div class="flex items-center space-x-4 pt-4 border-t border-gray-200">
        <input type="text" id="user-input" placeholder="Escribe tu duda aqu√≠..."
               class="flex-grow p-4 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary transition duration-150 shadow-inner text-gray-700">
        <button id="submit-button" onclick="handleQuery()"
                class="bg-primary hover:bg-teal-600 text-white font-bold py-4 px-6 rounded-xl transition duration-150 shadow-lg disabled:opacity-50 flex items-center justify-center transform hover:scale-105">
            Enviar
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.149 1.493 1 1 0 00.957.283L10 18l5.894 1.748a1 1 0 00.957-.283 1 1 0 00.149-1.493l-7-14z" />
            </svg>
        </button>
    </div>

    <!-- ALERTAS -->
    <div id="loading-indicator" class="mt-4 text-center hidden">
        <div class="flex justify-center items-center space-x-2 p-2 bg-blue-50 rounded-lg shadow-inner">
            <svg class="animate-spin h-5 w-5 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Consultando normativa vigente...</span>
        </div>
    </div>
    <div id="system-message" class="mt-4 text-sm text-red-600 hidden p-2 rounded-lg bg-red-100 shadow-inner text-center"></div>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    
    const apiKey = "AIzaSyC_s2iz6pAyreN5Gz3QPutYt9rPdoMJFv8"; 
    const GOOGLE_SHEET_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx66XyLh4kwvzt8U8GkVWqJ24bvvF9mRI3WGXMj7f7K_al2tU8PSlAU7wgS_BAKPjVc/exec'; 

    const API_MODEL = "gemini-2.5-flash-preview-09-2025";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;
    const MAX_RETRIES = 5;
    const QUERY_LIMIT = 5; 
    const STORAGE_KEY_PREFIX = 'extranjeria_es_v5_'; // Nueva versi√≥n para limpiar cach√©

    // DOM Elements
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const submitButton = document.getElementById('submit-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const systemMessage = document.getElementById('system-message');
    const queryLimitStatus = document.getElementById('query-limit-status');
    const emailCaptureScreen = document.getElementById('email-capture-screen');
    const captureEmailInput = document.getElementById('capture-email-input');
    const startSessionButton = document.getElementById('start-session-button');
    const emailErrorMessage = document.getElementById('email-error-message');
    
    let userSessionId = null;
    let currentQueryCount = 0;
    let totalQueriesMade = 0;

    // --- FUNCIONES UI ---
    function showSystemMessage(message, isError = true) {
        systemMessage.innerHTML = message;
        systemMessage.classList.remove('hidden');
        systemMessage.className = isError ? "mt-4 text-sm text-red-600 p-2 rounded-lg bg-red-100 shadow-inner text-center" : "mt-4 text-sm text-green-600 p-2 rounded-lg bg-green-100 shadow-inner text-center";
    }
    
    function scrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }

    function appendMessage(text, isUser, sources = []) {
        const container = document.createElement('div');
        container.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `message-bubble p-4 max-w-lg shadow-lg transition duration-300 ${isUser ? 'user-message text-white' : 'ai-message text-gray-800'}`;
        
        if (!isUser) {
            const title = document.createElement('p');
            title.className = 'font-semibold text-accent mb-1 text-xs uppercase tracking-wider';
            title.textContent = 'Asistente Seguren';
            bubble.appendChild(title);
        }
        
        const messageText = document.createElement('p');
        let formattedText = text.replace(/\n/g, '<br>');
        formattedText = formattedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-semibold">$1</a>');
        
        messageText.innerHTML = formattedText;
        bubble.appendChild(messageText);

        if (!isUser && sources.length > 0) {
            const sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'mt-3 pt-3 border-t border-gray-400 border-opacity-50 text-xs';
            const sourcesTitle = document.createElement('p');
            sourcesTitle.className = 'font-semibold mb-1 italic';
            sourcesTitle.textContent = 'Fuentes verificadas:';
            sourcesContainer.appendChild(sourcesTitle);
            const sourcesList = document.createElement('ul');
            sourcesList.className = 'list-disc list-inside space-y-0.5';
            sources.forEach((source, index) => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = source.uri;
                link.target = '_blank';
                link.className = 'text-blue-700 hover:text-blue-900 underline break-words';
                link.textContent = source.title || `Fuente ${index + 1}`;
                listItem.appendChild(link);
                sourcesList.appendChild(listItem);
            });
            sourcesContainer.appendChild(sourcesList);
            bubble.appendChild(sourcesContainer);
        }
        container.appendChild(bubble);
        chatWindow.appendChild(container);
        scrollToBottom();
    }
    
    function isValidEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }
    
    function getTodayDate() { return new Date().toISOString().slice(0, 10); }
    
    // --- ENVIAR DATOS COMPLETOS A SHEETS ---
    async function sendEmailToExternalService(email, count, totalCount, query = "", response = "") {
        const params = new URLSearchParams({ 
            email: email, 
            count: count, 
            total_count: totalCount,
            last_query: query,
            last_response: response
        }).toString();
        try {
            await fetch(`${GOOGLE_SHEET_APPS_SCRIPT_URL}?${params}`, { method: 'POST', mode: 'no-cors' });
            console.log("Datos enviados a Sheets");
        } catch (error) { console.error("Error Sheets:", error); }
    }
    
    // --- L√çMITES ---
    function checkAndIncrementQueryCount() {
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        const today = getTodayDate();
        let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: today, totalCount: 0 };
        totalQueriesMade = sessionData.totalCount || 0;
        if (sessionData.lastDate !== today) { sessionData.count = 1; sessionData.lastDate = today; } 
        else { sessionData.count = (sessionData.count || 0) + 1; }
        sessionData.totalCount = (sessionData.totalCount || 0) + 1;
        currentQueryCount = sessionData.count;
        totalQueriesMade = sessionData.totalCount;
        localStorage.setItem(sessionKey, JSON.stringify(sessionData));
        return currentQueryCount <= QUERY_LIMIT;
    }
    
    function loadSession() {
        const storedEmail = localStorage.getItem(STORAGE_KEY_PREFIX + 'email');
        if (storedEmail) {
            userSessionId = storedEmail;
            emailCaptureScreen.classList.add('hidden');
            const sessionKey = STORAGE_KEY_PREFIX + storedEmail;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: getTodayDate() };
            currentQueryCount = (sessionData.lastDate === getTodayDate()) ? sessionData.count : 0;
            
            updateLimitStatusUI(); 
            if (chatWindow.children.length === 0) {
                 appendMessage(`¬°Hola! üëã Qu√© alegr√≠a saludarte. Soy tu asistente virtual especializado en tr√°mites para vivir en Espa√±a. Estoy aqu√≠ para guiarte y aclarar tus dudas en este proceso.<br><br>Antes de empezar, ten en cuenta que mis respuestas son orientativas para ayudarte a entender mejor el camino; para pasos legales definitivos, siempre es recomendable validar con un Gestor o Abogado. ¬øEn qu√© te puedo ayudar hoy?`, false);
            }
        } else { emailCaptureScreen.classList.remove('hidden'); }
    }
    
    function updateLimitStatusUI() {
        const remaining = Math.max(0, QUERY_LIMIT - currentQueryCount);
        
        if (remaining === 0) {
            queryLimitStatus.textContent = `L√≠mite diario alcanzado`;
            queryLimitStatus.className = "limit-badge bg-red-100 text-red-600 border border-red-200";
            submitButton.disabled = true;
            userInput.placeholder = "¬°Gracias por usar nuestro servicio!";
            showSystemMessage("<b>¬°Has llegado al l√≠mite diario!</b><br>Hacemos esto de esta forma para que todos puedan acceder de forma gratuita y podamos colaborar con la mayor cantidad de gente posible. ¬°Te esperamos ma√±ana para seguir avanzando con tus tr√°mites!", true);
        } else {
            queryLimitStatus.textContent = `${remaining} consultas disponibles hoy`;
            queryLimitStatus.className = "limit-badge";
            submitButton.disabled = false;
            userInput.placeholder = "Escribe tu duda aqu√≠...";
            systemMessage.classList.add('hidden');
        }
    }

    startSessionButton.addEventListener('click', () => {
        const email = captureEmailInput.value.trim();
        emailErrorMessage.classList.add('hidden');
        if (!isValidEmail(email)) { emailErrorMessage.classList.remove('hidden'); return; }
        localStorage.setItem(STORAGE_KEY_PREFIX + 'email', email);
        userSessionId = email; 
        
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        if (!localStorage.getItem(sessionKey)) {
             localStorage.setItem(sessionKey, JSON.stringify({ count: 0, lastDate: getTodayDate(), totalCount: 0 }));
        }
        sendEmailToExternalService(email, 0, 0, "Registro Inicial", "Bienvenida");
        loadSession();
    });

    // --- IA LOGIC (PERSONALIDAD AMIGABLE & SUTIL) ---
    function getLLMPayload(userQuery) {
        const systemPrompt = `Eres un Asistente de Extranjer√≠a muy amable, c√°lido y humano, especializado EXCLUSIVAMENTE en tr√°mites para residir en Espa√±a.
        
        TONO Y ESTILO:
        - S√© muy cercano y emp√°tico (usa frases como "Entiendo tu preocupaci√≥n", "Es un gran paso", "Estoy aqu√≠ para guiarte").
        - No suenes como un robot. Usa emojis ocasionalmente si el contexto lo permite (üá™üá∏, üìÑ, ‚ú®).
        - S√© claro y directo, pero siempre con calidez.
        
        REGLAS OBLIGATORIAS:
        1. SEGUROS DE SALUD (RECOMENDACI√ìN SUTIL): Si el usuario pregunta por seguros de salud o requisitos m√©dicos para visados/residencia, expl√≠cale los requisitos t√©cnicos (sin copagos, repatriaci√≥n, etc.). AL FINAL de esa explicaci√≥n, a√±ade textualmente este consejo: "Para contratar el seguro, tienes varias opciones: puedes contactar directamente con las aseguradoras o buscar comparadores en Google. Sin embargo, una forma que hemos validado como m√°s efectiva ‚Äîteniendo en cuenta el producto espec√≠fico para extranjer√≠a, el servicio y el precio‚Äî es utilizar brokers especializados como [Seguren.com](https://seguren.com), ya que facilitan el tr√°mite online y conocen exactamente lo que pide el consulado."
        2. TEMA: Si preguntan de otro pa√≠s, di amablemente: "Disculpa, mi especialidad es exclusivamente ayudarte a llegar a Espa√±a üá™üá∏. ¬øHay algo sobre ese destino que quieras saber?"
        3. AVISO LEGAL: Si la pregunta requiere asesoramiento legal complejo, recuerda recomendar un abogado.
        `;
        
        return {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }], 
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };
    }

    async function fetchExtranjeriaInfo(userQuery, retryCount = 0) {
        try {
            const payload = getLLMPayload(userQuery);
            const response = await fetch(apiUrl, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                        .filter(source => source.uri && source.title);
                }
                return { text, sources };
            } else { throw new Error("Respuesta vac√≠a."); }
        } catch (error) {
            if (retryCount < MAX_RETRIES) {
                const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchExtranjeriaInfo(userQuery, retryCount + 1);
            }
            throw error;
        }
    }

    window.handleQuery = async function () {
        const query = userInput.value.trim();
        if (query === "") return;
        if (!userSessionId) { showSystemMessage("Error: Debes iniciar sesi√≥n primero."); emailCaptureScreen.classList.remove('hidden'); return; }
        if (!checkAndIncrementQueryCount()) { updateLimitStatusUI(); return; }

        appendMessage(query, true);
        userInput.value = '';
        systemMessage.classList.add('hidden');
        submitButton.disabled = true;
        loadingIndicator.classList.remove('hidden');
        
        try {
            const aiResult = await fetchExtranjeriaInfo(query);
            appendMessage(aiResult.text, false, aiResult.sources);
            // ENVIAR A GOOGLE SHEETS (Pregunta + Respuesta)
            sendEmailToExternalService(userSessionId, currentQueryCount, totalQueriesMade, query, aiResult.text);
        } catch (error) {
            const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey));
            if (sessionData && sessionData.count > 0) {
                sessionData.count -= 1;
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                currentQueryCount = sessionData.count;
            }
            showSystemMessage("Hubo un peque√±o error t√©cnico. Por favor, preg√∫ntame de nuevo.");
        } finally {
            loadingIndicator.classList.add('hidden');
            updateLimitStatusUI(); 
            userInput.focus();
        }
    }
    
    userInput.addEventListener('keypress', function(event) { if (event.key === 'Enter' && !submitButton.disabled) { event.preventDefault(); window.handleQuery(); } });
    window.onload = loadSession;
</script>
</body>
</html>