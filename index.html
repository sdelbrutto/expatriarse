<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Residencia en EspaÃ±a - Expatriarse.com</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': '#10b981', 
                        'secondary': '#f97316', 
                        'accent': '#1e40af', 
                        'background': '#f4f4f5', 
                        'card': '#ffffff', 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f4f5; font-family: 'Inter', sans-serif; padding: 1rem; }
        .chat-container { max-width: 800px; height: 650px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .chat-window { height: calc(100% - 120px); overflow-y: auto; scroll-behavior: smooth; }
        .message-bubble { border-radius: 1.25rem; }
        .ai-message { background-color: #d1fae5; }
        .user-message { background-color: #3b82f6; }
        #email-capture-screen { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.98); z-index: 10; }
        
        .header-content { display: flex; flex-direction: row; align-items: center; justify-content: space-between; }
        .logo-title-group { display: flex; align-items: center; }
        .text-group { display: flex; flex-direction: column; justify-content: center; }
        
        .domain-title { font-size: 0.75rem; color: #6b7280; font-weight: 600; margin-bottom: 0px; text-transform: lowercase; letter-spacing: 0.05em; }
        .main-title { font-size: 1.1rem; font-weight: 800; color: #1e40af; line-height: 1.1; }
        .limit-badge { font-size: 0.75rem; font-weight: 600; color: #059669; background-color: #ecfdf5; padding: 0.25rem 0.75rem; rounded-full; border: 1px solid #10b981; }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen">

<div class="chat-container w-full bg-card rounded-3xl flex flex-col p-6">
    
    <div id="email-capture-screen" class="flex justify-center items-center p-8 text-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border border-gray-100">
            <img src="/logo.png" onerror="this.src='https://via.placeholder.com/150?text=Expatriarse'" alt="Logo Expatriarse" class="h-34 mx-auto mb-6 object-contain">
            
            <h2 class="text-2xl font-bold text-gray-800 mb-3 text-center">Bienvenido a tu Asistente de Residencia en EspaÃ±a ðŸ‡ªðŸ‡¸</h2>
            <p class="text-gray-600 mb-6 leading-relaxed text-sm text-center">
                Estamos aquÃ­ para ayudarte a resolver tus dudas migratorias. Para mantener esta herramienta gratuita y accesible para toda la comunidad, te pedimos un breve registro.<br><br>
                Al ingresar, tendrÃ¡s acceso a <strong>5 consultas de orientaciÃ³n gratuitas por dÃ­a</strong>.
            </p>
            
            <input type="email" id="capture-email-input" placeholder="Tu correo electrÃ³nico aquÃ­" 
                   class="w-full p-4 border border-gray-300 rounded-xl focus:ring-accent focus:border-accent transition duration-150 shadow-inner mb-4 text-gray-700 text-center text-lg">
            
            <button id="start-session-button" 
                    class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:opacity-50 transform hover:scale-[1.02]">
                Ingresar al Asistente
            </button>
            <p id="email-error-message" class="text-xs text-red-500 mt-3 hidden text-center">Por favor, escribe un email vÃ¡lido para continuar.</p>
        </div>
    </div>

    <header class="pb-4 border-b border-gray-200 relative">
        <div class="header-content">
            <div class="logo-title-group">
                <img src="/logo.png" onerror="this.style.display='none'" alt="Logo" class="h-24 mr-3 object-contain">
                <div class="text-group">
                    <span class="domain-title">expatriarse.com</span>
                    <h1 class="main-title">Asistente de Residencia</h1>
                </div>
            </div>
            <div id="limit-badge-container">
                <p id="query-limit-status" class="limit-badge">
                    5 consultas disponibles
                </p>
            </div>
        </div>
    </header>

    <div id="chat-window" class="chat-window flex flex-col space-y-4 p-4 mb-4 flex-grow"></div>

    <div class="flex items-center space-x-4 pt-4 border-t border-gray-200">
        <input type="text" id="user-input" placeholder="Escribe tu duda aquÃ­..."
               class="flex-grow p-4 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary transition duration-150 shadow-inner text-gray-700">
        <button id="submit-button" onclick="handleQuery()"
                class="bg-primary hover:bg-teal-600 text-white font-bold py-4 px-6 rounded-xl transition duration-150 shadow-lg disabled:opacity-50 flex items-center justify-center transform hover:scale-105">
            Enviar
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.149 1.493 1 1 0 00.957.283L10 18l5.894 1.748a1 1 0 00.957-.283 1 1 0 00.149-1.493l-7-14z" />
            </svg>
        </button>
    </div>

    <div id="loading-indicator" class="mt-4 text-center hidden">
        <div class="flex justify-center items-center space-x-2 p-2 bg-blue-50 rounded-lg shadow-inner">
            <svg class="animate-spin h-5 w-5 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Consultando informaciÃ³n...</span>
        </div>
    </div>
    <div id="system-message" class="mt-4 text-sm text-red-600 hidden p-2 rounded-lg bg-red-100 shadow-inner text-center"></div>
</div>

<script>
    // --- CONFIGURACIÃ“N ---
    const QUERY_LIMIT = 5; 
    const STORAGE_KEY_PREFIX = 'extranjeria_es_v5_'; 

    // DOM Elements
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const submitButton = document.getElementById('submit-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const systemMessage = document.getElementById('system-message');
    const queryLimitStatus = document.getElementById('query-limit-status');
    const emailCaptureScreen = document.getElementById('email-capture-screen');
    const captureEmailInput = document.getElementById('capture-email-input');
    const startSessionButton = document.getElementById('start-session-button');
    const emailErrorMessage = document.getElementById('email-error-message');
    
    let userSessionId = null;
    let currentQueryCount = 0;

    // --- FUNCIONES UI ---
    function showSystemMessage(message, isError = true) {
        systemMessage.innerHTML = message;
        systemMessage.classList.remove('hidden');
        systemMessage.className = isError ? "mt-4 text-sm text-red-600 p-2 rounded-lg bg-red-100 shadow-inner text-center" : "mt-4 text-sm text-green-600 p-2 rounded-lg bg-green-100 shadow-inner text-center";
    }
    
    function scrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }

    function appendMessage(text, isUser) {
        const container = document.createElement('div');
        container.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `message-bubble p-4 max-w-lg shadow-lg transition duration-300 ${isUser ? 'user-message text-white' : 'ai-message text-gray-800'}`;
        
        if (!isUser) {
            const title = document.createElement('p');
            title.className = 'font-semibold text-accent mb-1 text-xs uppercase tracking-wider';
            title.textContent = 'Asistente Expatriarse'; // NOMBRE CORREGIDO
            bubble.appendChild(title);
        }
        
        const messageText = document.createElement('p');
        // Convertir saltos de lÃ­nea y enlaces bÃ¡sicos
        let formattedText = text.replace(/\n/g, '<br>');
        // Enlaces Markdown [Texto](url)
        formattedText = formattedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-semibold">$1</a>');
        // Negritas Markdown **Texto**
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        messageText.innerHTML = formattedText;
        bubble.appendChild(messageText);

        container.appendChild(bubble);
        chatWindow.appendChild(container);
        scrollToBottom();
    }
    
    function isValidEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }
    
    function getTodayDate() { return new Date().toISOString().slice(0, 10); }
    
    // --- GESTIÃ“N DE LÃMITES ---
    function checkAndIncrementQueryCount() {
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        const today = getTodayDate();
        let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: today };
        
        if (sessionData.lastDate !== today) { sessionData.count = 0; sessionData.lastDate = today; } 
        
        if (sessionData.count >= QUERY_LIMIT) return false;

        sessionData.count += 1;
        currentQueryCount = sessionData.count;
        localStorage.setItem(sessionKey, JSON.stringify(sessionData));
        return true;
    }
    
    function loadSession() {
        const storedEmail = localStorage.getItem(STORAGE_KEY_PREFIX + 'email');
        if (storedEmail) {
            userSessionId = storedEmail;
            emailCaptureScreen.classList.add('hidden');
            const sessionKey = STORAGE_KEY_PREFIX + storedEmail;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: getTodayDate() };
            currentQueryCount = (sessionData.lastDate === getTodayDate()) ? sessionData.count : 0;
            
            updateLimitStatusUI(); 
            if (chatWindow.children.length === 0) {
                 appendMessage(`Â¡Hola! ðŸ‘‹ QuÃ© alegrÃ­a saludarte. Soy tu asistente virtual especializado en trÃ¡mites para vivir en EspaÃ±a. Estoy conectado de forma segura para ayudarte. Â¿QuÃ© necesitas saber hoy?`, false);
            }
        } else { emailCaptureScreen.classList.remove('hidden'); }
    }
    
    function updateLimitStatusUI() {
        const remaining = Math.max(0, QUERY_LIMIT - currentQueryCount);
        
        if (remaining === 0) {
            queryLimitStatus.textContent = `LÃ­mite diario alcanzado`;
            queryLimitStatus.className = "limit-badge bg-red-100 text-red-600 border border-red-200";
            submitButton.disabled = true;
            userInput.placeholder = "Â¡Gracias por usar nuestro servicio!";
            showSystemMessage("<b>Â¡Has llegado al lÃ­mite diario!</b><br>Hacemos esto para que todos puedan acceder de forma gratuita. Â¡Te esperamos maÃ±ana!", true);
        } else {
            queryLimitStatus.textContent = `${remaining} consultas disponibles hoy`;
            queryLimitStatus.className = "limit-badge";
            submitButton.disabled = false;
            userInput.placeholder = "Escribe tu duda aquÃ­...";
            systemMessage.classList.add('hidden');
        }
    }

    startSessionButton.addEventListener('click', () => {
        const email = captureEmailInput.value.trim();
        emailErrorMessage.classList.add('hidden');
        if (!isValidEmail(email)) { emailErrorMessage.classList.remove('hidden'); return; }
        localStorage.setItem(STORAGE_KEY_PREFIX + 'email', email);
        userSessionId = email; 
        
        // Inicializar sesiÃ³n local
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        if (!localStorage.getItem(sessionKey)) {
             localStorage.setItem(sessionKey, JSON.stringify({ count: 0, lastDate: getTodayDate() }));
        }
        loadSession();
    });

    // --- MANEJO DE LA CONSULTA AL SERVIDOR ---
    window.handleQuery = async function () {
        const query = userInput.value.trim();
        if (query === "") return;
        
        if (!userSessionId) { 
            showSystemMessage("Error: Debes iniciar sesiÃ³n primero."); 
            emailCaptureScreen.classList.remove('hidden'); 
            return; 
        }

        // Verificar lÃ­mite ANTES de llamar al servidor
        if (!checkAndIncrementQueryCount()) { 
            updateLimitStatusUI(); 
            return; 
        }

        // UI Update
        appendMessage(query, true);
        userInput.value = '';
        systemMessage.classList.add('hidden');
        submitButton.disabled = true;
        loadingIndicator.classList.remove('hidden');
        
        try {
            // Llamada Segura a TU Backend (Vercel)
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // CORRECCIÃ“N: Enviamos 'message' y 'email' como espera tu servidor nuevo
                body: JSON.stringify({ 
                    message: query, 
                    email: userSessionId 
                })
            });

            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.status}`);
            }

            const data = await response.json();
            
            // CORRECCIÃ“N: Tu servidor devuelve 'response', no 'text'
            const aiResponse = data.response || "Lo siento, hubo un error al procesar la respuesta.";
            
            appendMessage(aiResponse, false);

            // NOTA: El guardado en Google Sheets ahora lo hace el servidor automÃ¡ticamente,
            // asÃ­ que no necesitamos cÃ³digo aquÃ­ para eso. Â¡MÃ¡s seguro!

        } catch (error) {
            console.error("Error:", error);
            // Si falla, devolvemos el crÃ©dito al usuario
            const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey));
            if (sessionData && sessionData.count > 0) {
                sessionData.count -= 1;
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                currentQueryCount = sessionData.count;
            }
            showSystemMessage("Hubo un problema de conexiÃ³n. Intenta de nuevo.");
        } finally {
            loadingIndicator.classList.add('hidden');
            updateLimitStatusUI(); 
            userInput.focus();
        }
    }
    
    userInput.addEventListener('keypress', function(event) { 
        if (event.key === 'Enter' && !submitButton.disabled) { 
            event.preventDefault(); 
            window.handleQuery(); 
        } 
    });
    
    window.onload = loadSession;
</script>
</body>
</html>
