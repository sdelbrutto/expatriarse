<script>
    // --- CONFIGURACI√ìN ---
    
    const GOOGLE_SHEET_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx66XyLh4kwvzt8U8GkVWqJ24bvvF9mRI3WGXMj7f7K_al2tU8PSlAU7wgS_BAKPjVc/exec'; 

    const MAX_RETRIES = 5;
    const QUERY_LIMIT = 5; 
    const STORAGE_KEY_PREFIX = 'extranjeria_es_v5_'; 

    // DOM Elements
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const submitButton = document.getElementById('submit-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const systemMessage = document.getElementById('system-message');
    const queryLimitStatus = document.getElementById('query-limit-status');
    const emailCaptureScreen = document.getElementById('email-capture-screen');
    const captureEmailInput = document.getElementById('capture-email-input');
    const startSessionButton = document.getElementById('start-session-button');
    const emailErrorMessage = document.getElementById('email-error-message');
    
    let userSessionId = null;
    let currentQueryCount = 0;
    let totalQueriesMade = 0;

    // --- FUNCIONES UI ---
    function showSystemMessage(message, isError = true) {
        systemMessage.innerHTML = message;
        systemMessage.classList.remove('hidden');
        systemMessage.className = isError ? "mt-4 text-sm text-red-600 p-2 rounded-lg bg-red-100 shadow-inner text-center" : "mt-4 text-sm text-green-600 p-2 rounded-lg bg-green-100 shadow-inner text-center";
    }
    
    function scrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }

    function appendMessage(text, isUser, sources = []) {
        const container = document.createElement('div');
        container.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `message-bubble p-4 max-w-lg shadow-lg transition duration-300 ${isUser ? 'user-message text-white' : 'ai-message text-gray-800'}`;
        
        if (!isUser) {
            const title = document.createElement('p');
            title.className = 'font-semibold text-accent mb-1 text-xs uppercase tracking-wider';
            title.textContent = 'Asistente Seguren';
            bubble.appendChild(title);
        }
        
        const messageText = document.createElement('p');
        let formattedText = text.replace(/\n/g, '<br>');
        formattedText = formattedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-semibold">$1</a>');
        
        messageText.innerHTML = formattedText;
        bubble.appendChild(messageText);

        if (!isUser && sources.length > 0) {
            const sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'mt-3 pt-3 border-t border-gray-400 border-opacity-50 text-xs';
            const sourcesTitle = document.createElement('p');
            sourcesTitle.className = 'font-semibold mb-1 italic';
            sourcesTitle.textContent = 'Fuentes verificadas:';
            sourcesContainer.appendChild(sourcesTitle);
            const sourcesList = document.createElement('ul');
            sourcesList.className = 'list-disc list-inside space-y-0.5';
            sources.forEach((source, index) => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = source.uri;
                link.target = '_blank';
                link.className = 'text-blue-700 hover:text-blue-900 underline break-words';
                link.textContent = source.title || `Fuente ${index + 1}`;
                listItem.appendChild(link);
                sourcesList.appendChild(listItem);
            });
            sourcesContainer.appendChild(sourcesList);
            bubble.appendChild(sourcesContainer);
        }
        container.appendChild(bubble);
        chatWindow.appendChild(container);
        scrollToBottom();
    }
    
    function isValidEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }
    
    function getTodayDate() { return new Date().toISOString().slice(0, 10); }
    
    // --- ENVIAR DATOS COMPLETOS A SHEETS ---
    async function sendEmailToExternalService(email, count, totalCount, query = "", response = "") {
        const params = new URLSearchParams({ 
            email: email, 
            count: count, 
            total_count: totalCount,
            last_query: query,
            last_response: response
        }).toString();
        try {
            await fetch(`${GOOGLE_SHEET_APPS_SCRIPT_URL}?${params}`, { method: 'POST', mode: 'no-cors' });
            console.log("Datos enviados a Sheets");
        } catch (error) { console.error("Error Sheets:", error); }
    }
    
    // --- L√çMITES ---
    function checkAndIncrementQueryCount() {
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        const today = getTodayDate();
        let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: today, totalCount: 0 };
        totalQueriesMade = sessionData.totalCount || 0;
        if (sessionData.lastDate !== today) { sessionData.count = 1; sessionData.lastDate = today; } 
        else { sessionData.count = (sessionData.count || 0) + 1; }
        sessionData.totalCount = (sessionData.totalCount || 0) + 1;
        currentQueryCount = sessionData.count;
        totalQueriesMade = sessionData.totalCount;
        localStorage.setItem(sessionKey, JSON.stringify(sessionData));
        return currentQueryCount <= QUERY_LIMIT;
    }
    
    function loadSession() {
        const storedEmail = localStorage.getItem(STORAGE_KEY_PREFIX + 'email');
        if (storedEmail) {
            userSessionId = storedEmail;
            emailCaptureScreen.classList.add('hidden');
            const sessionKey = STORAGE_KEY_PREFIX + storedEmail;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey)) || { count: 0, lastDate: getTodayDate() };
            currentQueryCount = (sessionData.lastDate === getTodayDate()) ? sessionData.count : 0;
            
            updateLimitStatusUI(); 
            if (chatWindow.children.length === 0) {
                 appendMessage(`¬°Hola! üëã Qu√© alegr√≠a saludarte. Soy tu asistente virtual especializado en tr√°mites para vivir en Espa√±a. Estoy aqu√≠ para guiarte y aclarar tus dudas en este proceso.<br><br>Antes de empezar, ten en cuenta que mis respuestas son orientativas para ayudarte a entender mejor el camino; para pasos legales definitivos, siempre es recomendable validar con un Gestor o Abogado. ¬øEn qu√© te puedo ayudar hoy?`, false);
            }
        } else { emailCaptureScreen.classList.remove('hidden'); }
    }
    
    function updateLimitStatusUI() {
        const remaining = Math.max(0, QUERY_LIMIT - currentQueryCount);
        
        if (remaining === 0) {
            queryLimitStatus.textContent = `L√≠mite diario alcanzado`;
            queryLimitStatus.className = "limit-badge bg-red-100 text-red-600 border border-red-200";
            submitButton.disabled = true;
            userInput.placeholder = "¬°Gracias por usar nuestro servicio!";
            showSystemMessage("<b>¬°Has llegado al l√≠mite diario!</b><br>Hacemos esto de esta forma para que todos puedan acceder de forma gratuita y podamos colaborar con la mayor cantidad de gente posible. ¬°Te esperamos ma√±ana para seguir avanzando con tus tr√°mites!", true);
        } else {
            queryLimitStatus.textContent = `${remaining} consultas disponibles hoy`;
            queryLimitStatus.className = "limit-badge";
            submitButton.disabled = false;
            userInput.placeholder = "Escribe tu duda aqu√≠...";
            systemMessage.classList.add('hidden');
        }
    }

    startSessionButton.addEventListener('click', () => {
        const email = captureEmailInput.value.trim();
        emailErrorMessage.classList.add('hidden');
        if (!isValidEmail(email)) { emailErrorMessage.classList.remove('hidden'); return; }
        localStorage.setItem(STORAGE_KEY_PREFIX + 'email', email);
        userSessionId = email; 
        
        const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
        if (!localStorage.getItem(sessionKey)) {
             localStorage.setItem(sessionKey, JSON.stringify({ count: 0, lastDate: getTodayDate(), totalCount: 0 }));
        }
        sendEmailToExternalService(email, 0, 0, "Registro Inicial", "Bienvenida");
        loadSession();
    });

    // --- LLAMADA A TU API BACKEND /api/chat ---
    async function fetchExtranjeriaInfo(userQuery, retryCount = 0) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: userQuery })
            });
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const result = await response.json();
            return {
                text: result.text || "Lo siento, no pude obtener una respuesta en este momento.",
                sources: result.sources || []
            };
        } catch (error) {
            console.error("Error en fetchExtranjeriaInfo:", error);
            if (retryCount < MAX_RETRIES) {
                const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchExtranjeriaInfo(userQuery, retryCount + 1);
            }
            throw error;
        }
    }

    window.handleQuery = async function () {
        const query = userInput.value.trim();
        if (query === "") return;
        if (!userSessionId) { showSystemMessage("Error: Debes iniciar sesi√≥n primero."); emailCaptureScreen.classList.remove('hidden'); return; }
        if (!checkAndIncrementQueryCount()) { updateLimitStatusUI(); return; }

        appendMessage(query, true);
        userInput.value = '';
        systemMessage.classList.add('hidden');
        submitButton.disabled = true;
        loadingIndicator.classList.remove('hidden');
        
        try {
            const aiResult = await fetchExtranjeriaInfo(query);
            appendMessage(aiResult.text, false, aiResult.sources);
            // ENVIAR A GOOGLE SHEETS (Pregunta + Respuesta)
            sendEmailToExternalService(userSessionId, currentQueryCount, totalQueriesMade, query, aiResult.text);
        } catch (error) {
            const sessionKey = STORAGE_KEY_PREFIX + userSessionId;
            let sessionData = JSON.parse(localStorage.getItem(sessionKey));
            if (sessionData && sessionData.count > 0) {
                sessionData.count -= 1;
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                currentQueryCount = sessionData.count;
            }
            showSystemMessage("Hubo un peque√±o error t√©cnico. Por favor, preg√∫ntame de nuevo.");
        } finally {
            loadingIndicator.classList.add('hidden');
            updateLimitStatusUI(); 
            userInput.focus();
        }
    }
    
    userInput.addEventListener('keypress', function(event) { if (event.key === 'Enter' && !submitButton.disabled) { event.preventDefault(); window.handleQuery(); } });
    window.onload = loadSession;
</script>
