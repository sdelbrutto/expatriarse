<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente de Residencia - expatriarse.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .message-appear { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Capa de bloqueo para el email */
    #email-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.98);
      z-index: 50; display: flex; justify-content: center; align-items: center;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div id="email-overlay" class="hidden">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-gray-100 text-center">
      <img src="/logo.png" alt="Logo" class="h-20 mx-auto mb-6 object-contain">
      
      <h2 class="text-2xl font-extrabold text-gray-900 mb-2">Bienvenido</h2>
      <p class="text-gray-600 mb-6 text-sm">
        Para acceder al asistente de extranjer√≠a gratuito, por favor ingresa tu correo electr√≥nico.
      </p>
      
      <form id="email-form" class="space-y-4">
        <input type="email" id="email-input" placeholder="tu@email.com" required
          class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition text-center text-lg">
        
        <button type="submit" 
          class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-xl transition duration-200 shadow-lg transform hover:scale-[1.02]">
          Comenzar
        </button>
      </form>
      <p id="email-error" class="text-red-500 text-xs mt-3 hidden">Por favor ingresa un correo v√°lido.</p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col h-screen">

    <header class="mb-4 text-center border-b border-gray-100 pb-4">
      <div class="flex justify-center">
        <img src="/logo.png" alt="Logo expatriarse.com" class="h-20 object-contain">
      </div>
    </header>

    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth pb-24">
      </main>

    <footer class="py-4 bg-white border-t border-gray-100 fixed bottom-0 left-0 right-0 w-full z-10">
      <div class="max-w-4xl mx-auto px-4">
        <form id="chat-form" class="flex gap-3 relative">
          <input
            type="text" id="user-input"
            class="w-full p-4 pr-14 border-2 border-gray-200 rounded-full focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all text-base shadow-sm placeholder-gray-400"
            placeholder="Escribe tu duda sobre extranjer√≠a..."
            required autocomplete="off"
          >
          <button type="submit" id="send-btn"
            class="absolute right-2 top-2 bottom-2 bg-gradient-to-r from-teal-500 to-teal-600 text-white px-6 rounded-full font-semibold hover:from-teal-600 hover:to-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-200 transition-all flex items-center justify-center shadow-md disabled:opacity-50">
            <span id="btn-text">Enviar</span>
            <svg id="loading-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </form>
      </div>
    </footer>

  </div>

  <script>
    // Variables de UI
    const emailOverlay = document.getElementById('email-overlay');
    const emailForm = document.getElementById('email-form');
    const emailInput = document.getElementById('email-input');
    const emailError = document.getElementById('email-error');
    
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const sendBtn = document.getElementById('send-btn');
    const btnText = document.getElementById('btn-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    let userEmail = localStorage.getItem('expatriarse_email');

    // 1. GESTI√ìN DE SESI√ìN (EMAIL)
    function checkSession() {
      if (!userEmail) {
        emailOverlay.classList.remove('hidden'); // Mostrar bloqueo
      } else {
        emailOverlay.classList.add('hidden');    // Ocultar bloqueo
        showWelcomeMessage();
      }
    }

    emailForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailRegex.test(email)) {
        emailError.classList.remove('hidden');
        return;
      }

      // Guardar email y desbloquear
      userEmail = email;
      localStorage.setItem('expatriarse_email', email);
      emailOverlay.classList.add('hidden');
      showWelcomeMessage();
    });

    // 2. CHAT UI
    function showWelcomeMessage() {
      if (chatBox.children.length === 0) {
        appendMessage('assistant', `¬°Hola! üëã Soy tu asistente virtual especializado en tr√°mites para vivir en Espa√±a. Estoy conectado de forma segura. ¬øQu√© necesitas saber hoy?`);
      }
    }

    function appendMessage(sender, text, isError = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex gap-3 message-appear ${sender === 'user' ? 'justify-end' : ''}`;

      let content = '';
      if (sender === 'user') {
        content = `<div class="bg-blue-50 text-gray-800 p-4 rounded-2xl rounded-tr-none shadow-sm border border-blue-100 max-w-3xl">
                     <p class="text-sm text-gray-800">${text}</p>
                   </div>`;
      } else {
        // Estilo Asistente
        const errorStyle = isError ? 'bg-red-50 text-red-700 border-red-200' : 'bg-white text-gray-700 border-gray-100';
        content = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-teal-400 to-blue-500 flex items-center justify-center flex-shrink-0 shadow-sm text-white text-xs">AI</div>
          <div class="${errorStyle} p-4 rounded-2xl rounded-tl-none shadow-md border max-w-3xl">
            <p class="text-xs font-bold text-teal-600 mb-1">ASISTENTE</p>
            <div class="prose max-w-none text-sm leading-relaxed" style="white-space: pre-wrap;">${text}</div>
          </div>`;
      }
      msgDiv.innerHTML = content;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      userInput.disabled = loading;
      if (loading) {
        btnText.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        userInput.placeholder = "Pensando...";
      } else {
        btnText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
        userInput.placeholder = "Escribe tu duda...";
        userInput.focus();
      }
    }

    // 3. ENVIAR MENSAJE (CONECTANDO EMAIL CON SHEET)
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage('user', message);
      userInput.value = '';
      setLoading(true);

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // AQU√ç SE ENV√çA EL EMAIL AL SERVIDOR
          body: JSON.stringify({ message, email: userEmail }) 
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Error server');
        if (data.response) appendMessage('assistant', data.response);

      } catch (error) {
        console.error(error);
        appendMessage('assistant', "Hubo un problema de conexi√≥n. Intenta de nuevo.", true);
      } finally {
        setLoading(false);
      }
    });

    // Iniciar
    checkSession();
  </script>
</body>
</html>
